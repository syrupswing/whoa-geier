<div class="dashboard-container">
  <h1>Home Dashboard</h1>

  <!-- Weather Bar -->
  <div class="weather-bar" 
       *ngIf="weatherService.weather() || weatherService.isLoading() || weatherService.error()" 
       [class]="weatherService.getWeatherConditionClass()"
       [class.night]="isNightTime()"
       [attr.data-time]="getTimeOfDay()"
       [attr.data-wind]="getWindIntensity()">
    
    <!-- Animated Background Effects -->
    <div class="weather-background">
      <!-- Stars for clear nights -->
      <div class="stars" *ngIf="shouldShowStars()">
        <div class="star" *ngFor="let i of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]"></div>
      </div>
      
      <!-- Moon for night time -->
      <div class="moon" *ngIf="isNightTime() && weatherService.weather()">
        <span class="moon-phase">{{ getMoonPhase() }}</span>
      </div>
      
      <!-- Precipitation effects -->
      <div class="precipitation" *ngIf="shouldShowPrecipitation()" [attr.data-type]="getPrecipitationType()">
        <div class="drop" *ngFor="let i of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40]"></div>
      </div>
      
      <!-- Wind effect (moving clouds/particles) -->
      <div class="wind-effect" [attr.data-intensity]="getWindIntensity()">
        <div class="wind-particle" *ngFor="let i of [1,2,3,4,5,6,7,8]"></div>
      </div>
    </div>
    
    <!-- Loaded Weather Content -->
    <div class="weather-bar-content" *ngIf="weatherService.weather()">
      <div class="weather-bar-main">
        <mat-icon class="weather-bar-icon">{{ getWeatherIcon() }}</mat-icon>
        <div class="weather-bar-temp">{{ weatherService.weather()?.temperature }}Â°F</div>
        <div class="weather-bar-description">{{ weatherService.weather()?.description | titlecase }}</div>
      </div>
      <div class="weather-bar-details">
        <span class="weather-bar-stat" matTooltip="Humidity">
          <mat-icon>water_drop</mat-icon>
          {{ weatherService.weather()?.humidity }}%
        </span>
        <span class="weather-bar-stat" matTooltip="Wind Speed">
          <mat-icon>air</mat-icon>
          {{ weatherService.weather()?.windSpeed }} mph
        </span>
        <span class="weather-bar-location">
          <mat-icon>location_on</mat-icon>
          {{ weatherService.weather()?.city }}
        </span>
      </div>
    </div>

    <!-- Clothing Recommendation -->
    <div class="clothing-recommendation" *ngIf="weatherService.weather() && clothingRecommendation()">
      <mat-icon class="clothing-icon">checkroom</mat-icon>
      <div class="clothing-text">
        {{ clothingRecommendation() }}
      </div>
    </div>
    
    <!-- Skeleton Loader -->
    <div class="weather-bar-skeleton" *ngIf="weatherService.isLoading() && !weatherService.weather()">
      <div class="skeleton-main">
        <div class="skeleton-circle shimmer"></div>
        <div class="skeleton-temp shimmer"></div>
        <div class="skeleton-desc shimmer"></div>
      </div>
      <div class="skeleton-details">
        <div class="skeleton-stat shimmer"></div>
        <div class="skeleton-stat shimmer"></div>
        <div class="skeleton-location shimmer"></div>
      </div>
      <div class="skeleton-message">
        <mat-icon class="pulse-icon">wb_sunny</mat-icon>
        <span class="skeleton-text">Checking the weather for you...</span>
      </div>
    </div>
    
    <!-- Error State -->
    <div class="weather-bar-error" *ngIf="weatherService.error() && !weatherService.weather()">
      <mat-icon>error_outline</mat-icon>
      <span>{{ weatherService.error() }}</span>
      <button mat-button (click)="weatherService.loadWeather()">Retry</button>
    </div>
  </div>

  <div class="grid">
    
    <!-- Calendar Widget -->
    <mat-card class="calendar-widget">
      <mat-card-header>
        <mat-card-title>
          <div class="widget-header">
            <div class="widget-title">
              <mat-icon>event</mat-icon>
              Today's Schedule
              <span class="spacer"></span>
            </div>
          </div>
        </mat-card-title>
        <mat-card-subtitle *ngIf="calendarService.isSignedIn()">{{ currentTime() | date:'EEEE, MMMM d' }}</mat-card-subtitle>
        <mat-card-subtitle *ngIf="!calendarService.isSignedIn()">Connect to view your calendar</mat-card-subtitle>
        <div class="widget-actions">
          <a mat-icon-button [routerLink]="'/calendar'" class="calendar-link">
            <mat-icon>open_in_new</mat-icon>
          </a>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="calendarService.isSignedIn(); else calendarDisconnected">
          <div class="timeline-container-small" #dashboardTimeline>
            <div class="time-labels-small">
              <div *ngFor="let hour of hours" class="time-label-small">
                {{ formatHour(hour) }}
              </div>
            </div>
            <div class="timeline-grid-small">
              <div *ngFor="let hour of hours" class="hour-line-small"></div>
              
              <div 
                class="current-time-indicator-small"
                [style.top.px]="getCurrentTimePosition()">
                <div class="time-marker-small"></div>
                <div class="time-line-small"></div>
              </div>

              <div 
                *ngFor="let event of getTodayEvents()"
                class="timeline-event-small"
                [style.top.px]="event.topPosition"
                [style.height.px]="event.height"
                [style.background-color]="getEventColor(event)">
                <div class="event-content-small">
                  <strong>{{ event.summary }}</strong>
                  <div class="event-time-tiny">{{ formatEventTime(event) }}</div>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="getTodayEvents().length === 0" class="no-events-small">
            <mat-icon>event_available</mat-icon>
            <p>No events today</p>
          </div>
        </div>
        <ng-template #calendarDisconnected>
          <div class="calendar-connect-placeholder">
            <mat-icon>event_busy</mat-icon>
            <h3>Calendar Not Connected</h3>
            <p>Connect your Google Calendar to see your family's schedule right here on the dashboard.</p>
            <button 
              mat-raised-button 
              color="primary" 
              (click)="signInToCalendar()"
              [disabled]="!calendarService.isInitialized()">
              <mat-icon>login</mat-icon>
              Connect Google Calendar
            </button>
            <p class="loading-text" *ngIf="!calendarService.isInitialized()">
              <mat-icon>hourglass_empty</mat-icon>
              Initializing...
            </p>
          </div>
        </ng-template>
      </mat-card-content>
    </mat-card>

    <!-- Grocery List Widget -->
    <mat-card class="grocery-widget">
      <mat-card-header>
        <mat-card-title>
          <div class="widget-header">
            <div class="widget-title">
              <mat-icon>shopping_cart</mat-icon>
              Grocery List
              <span class="count-badge" *ngIf="getTotalActiveCount() > 0">{{ getTotalActiveCount() }}</span>
            </div>
          </div>
        </mat-card-title>
        <mat-card-subtitle>
          <mat-icon class="storage-icon">{{ groceryService.useFirestore() ? 'cloud_done' : 'storage' }}</mat-icon>
          {{ groceryService.useFirestore() ? 'Synced with family' : 'Saved locally' }}
        </mat-card-subtitle>
        <div class="widget-actions">
          <a mat-icon-button [routerLink]="'/food'" class="grocery-link">
            <mat-icon>open_in_new</mat-icon>
          </a>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="add-item-form-compact">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Add item</mat-label>
            <input 
              matInput 
              [(ngModel)]="newItemName"
              (keyup.enter)="addGroceryItem()"
              placeholder="Enter item"
              autocomplete="off">
          </mat-form-field>
          <button 
            mat-mini-fab 
            color="primary" 
            (click)="addGroceryItem()"
            [disabled]="!newItemName.trim()">
            <mat-icon>add</mat-icon>
          </button>
        </div>
        <div *ngIf="getActiveGroceryItems().length > 0; else noGroceryItems">
          <mat-list class="grocery-list-compact">
            <mat-list-item *ngFor="let item of getActiveGroceryItems()">
              <mat-checkbox 
                [checked]="item.completed"
                (change)="toggleGroceryItem(item.id)"
                matListItemIcon>
              </mat-checkbox>
              <span matListItemTitle>{{ item.name }}</span>
            </mat-list-item>
          </mat-list>
          <div class="more-items" *ngIf="getTotalActiveCount() > 5">
            <a mat-button [routerLink]="'/food'" color="primary">
              +{{ getTotalActiveCount() - 5 }} more items
            </a>
          </div>
        </div>
        <ng-template #noGroceryItems>
          <div class="no-items-small">
            <mat-icon>shopping_cart</mat-icon>
            <p>No items in your list</p>
            <a mat-button [routerLink]="'/food'" color="primary">
              Add items
            </a>
          </div>
        </ng-template>
      </mat-card-content>
    </mat-card>

    <!-- AI Chat Widget -->
    <mat-card class="chat-widget">
      <mat-card-header>
        <mat-card-title>
          <div class="widget-header">
            <div class="widget-title">
              <mat-icon>psychology</mat-icon>
              AI Assistant
            </div>
          </div>
        </mat-card-title>
        <mat-card-subtitle>Ask me anything about family organization</mat-card-subtitle>
        <div class="widget-actions">
          <button mat-icon-button (click)="clearChat()" *ngIf="chatMessages().length > 0" matTooltip="Clear chat">
            <mat-icon>delete_sweep</mat-icon>
          </button>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="chat-messages" #chatContainer>
          <div *ngIf="chatMessages().length === 0" class="chat-empty">
            <mat-icon>chat_bubble_outline</mat-icon>
            <p>Start a conversation!</p>
            <p class="subtitle">Ask about meal planning, schedules, or organizing tips</p>
          </div>
          <div *ngFor="let message of chatMessages()" 
               class="chat-message"
               [class.user-message]="message.isUser"
               [class.ai-message]="!message.isUser">
            <div class="message-content">
              <mat-icon class="message-icon">{{ message.isUser ? 'person' : 'smart_toy' }}</mat-icon>
              <div class="message-text">{{ message.text }}</div>
            </div>
            <div class="message-time">{{ message.timestamp | date:'shortTime' }}</div>
          </div>
          <div *ngIf="isChatLoading()" class="chat-message ai-message loading">
            <div class="message-content">
              <mat-icon class="message-icon">smart_toy</mat-icon>
              <div class="message-text">
                <mat-spinner diameter="20"></mat-spinner>
                Thinking...
              </div>
            </div>
          </div>
        </div>
        <div class="chat-input-container">
          <mat-form-field appearance="outline" class="chat-input-field">
            <input 
              matInput 
              [(ngModel)]="chatInput"
              (keyup.enter)="sendChatMessage()"
              placeholder="Type your message..."
              [disabled]="isChatLoading()">
          </mat-form-field>
          <button 
            mat-mini-fab 
            color="primary" 
            (click)="sendChatMessage()"
            [disabled]="!chatInput.trim() || isChatLoading()">
            <mat-icon>send</mat-icon>
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card *ngFor="let card of cards" class="dashboard-card">
      <mat-card-header>
        <div mat-card-avatar class="card-icon" [style.background-color]="card.color">
          <mat-icon>{{ card.icon }}</mat-icon>
        </div>
        <mat-card-title>{{ card.title }}</mat-card-title>
        <mat-card-subtitle>{{ card.description }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-actions>
        <button mat-raised-button color="primary" [routerLink]="card.route">
          Open
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>
