import{a as r}from"./chunk-GV272NIX.js";import{a as g}from"./chunk-ST5TOAOU.js";import{Ma as o,Z as l,ca as d,e as s}from"./chunk-M5WQ34XW.js";var E=(()=>{class n{constructor(e){this.localStorageService=e,this.TOKEN_STORAGE_KEY="google-calendar-token",this.isSignedIn=o(!1),this.isInitialized=o(!1),this.events=o([]),this.error=o(null),this.gapiInited=!1,this.initializeGapi()}initializeGapi(){return s(this,null,function*(){try{yield this.loadGapiScript(),yield new Promise((e,i)=>{gapi.load("client",()=>s(this,null,function*(){try{let t={discoveryDocs:r.googleCalendar.discoveryDocs};r.googleCalendar.apiKey&&r.googleCalendar.apiKey.startsWith("AIza")&&(t.apiKey=r.googleCalendar.apiKey),yield gapi.client.init(t),this.gapiInited=!0,e()}catch(t){this.error.set(`Error initializing GAPI: ${t.message}`),i(t)}}))}),yield this.loadGsiScript(),this.tokenClient=window.google.accounts.oauth2.initTokenClient({client_id:r.googleCalendar.clientId,scope:r.googleCalendar.scopes,prompt:"",callback:e=>{if(e.error){this.error.set(e.error);return}this.saveToken(e),this.isSignedIn.set(!0),this.loadCalendarEvents()}}),this.isInitialized.set(!0),this.checkSavedToken()}catch(e){this.error.set(`Initialization error: ${e.message}`),console.error("Error initializing Google Calendar API:",e)}})}loadGapiScript(){return new Promise((e,i)=>{if(window.gapi){e();return}let t=document.createElement("script");t.src="https://apis.google.com/js/api.js",t.onload=()=>e(),t.onerror=()=>i(new Error("Failed to load GAPI script")),document.head.appendChild(t)})}loadGsiScript(){return new Promise((e,i)=>{if(window.google?.accounts){e();return}let t=document.createElement("script");t.src="https://accounts.google.com/gsi/client",t.onload=()=>e(),t.onerror=()=>i(new Error("Failed to load GSI script")),document.head.appendChild(t)})}signIn(){if(!this.isInitialized()){this.error.set("Google API not initialized yet");return}gapi.client.getToken()===null?this.tokenClient.requestAccessToken({prompt:"consent"}):this.tokenClient.requestAccessToken({prompt:""})}signOut(){let e=gapi.client.getToken();e!==null&&(window.google.accounts.oauth2.revoke(e.access_token),gapi.client.setToken(null),this.isSignedIn.set(!1),this.events.set([]),this.localStorageService.removeItem(this.TOKEN_STORAGE_KEY))}saveToken(e){let i={access_token:e.access_token,expires_at:Date.now()+e.expires_in*1e3,token_type:e.token_type,scope:e.scope};this.localStorageService.setItem(this.TOKEN_STORAGE_KEY,i)}checkSavedToken(){let e=this.localStorageService.getItem(this.TOKEN_STORAGE_KEY);!e||!e.access_token||(e.expires_at&&Date.now()<e.expires_at?(gapi.client.setToken({access_token:e.access_token,token_type:e.token_type||"Bearer",scope:e.scope}),this.isSignedIn.set(!0),this.loadCalendarEvents()):this.localStorageService.removeItem(this.TOKEN_STORAGE_KEY))}loadCalendarEvents(e=60,i=7){return s(this,null,function*(){if(!(!this.gapiInited||!this.isSignedIn()))try{let t=new Date,a=new Date;a.setDate(t.getDate()-i);let c=new Date;c.setDate(t.getDate()+e);let p=(yield gapi.client.calendar.events.list({calendarId:"primary",timeMin:a.toISOString(),timeMax:c.toISOString(),showDeleted:!1,singleEvents:!0,maxResults:250,orderBy:"startTime"})).result.items||[];this.events.set(p),this.error.set(null)}catch(t){this.error.set(`Error loading events: ${t.message}`),console.error("Error loading calendar events:",t)}})}getEventsInRange(e,i){return s(this,null,function*(){if(!this.gapiInited||!this.isSignedIn())return[];try{return(yield gapi.client.calendar.events.list({calendarId:"primary",timeMin:e.toISOString(),timeMax:i.toISOString(),showDeleted:!1,singleEvents:!0,orderBy:"startTime"})).result.items||[]}catch(t){return this.error.set(`Error loading events: ${t.message}`),console.error("Error loading calendar events:",t),[]}})}static{this.\u0275fac=function(i){return new(i||n)(d(g))}}static{this.\u0275prov=l({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{E as a};
