name: Build and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Verify secrets are available
        run: |
          echo "Checking if secrets are set..."
          if [ -z "${{ secrets.FIREBASE_API_KEY }}" ]; then echo "⚠️  FIREBASE_API_KEY is not set"; fi
          if [ -z "${{ secrets.OPEN_WEATHER_API_KEY }}" ]; then echo "⚠️  OPEN_WEATHER_API_KEY is not set"; fi
          if [ -z "${{ secrets.GHAI_TOKEN }}" ]; then echo "⚠️  GHAI_TOKEN is not set"; fi
          echo "✅ Secret check complete"
        
      - name: Create production environment file with secrets
        env:
          FIREBASE_KEY: ${{ secrets.FIREBASE_API_KEY }}
          WEATHER_KEY: ${{ secrets.OPEN_WEATHER_API_KEY }}
          GHAI_TOKEN_VAR: ${{ secrets.GHAI_TOKEN }}
        run: |
          cat > src/environments/environment.prod.ts << 'EOF'
          export const environment = {
            production: true,
            googleCalendar: {
              apiKey: '',
              clientId: '675585365638-bi72vup1j25pgpa2orhul8i18507cs4p.apps.googleusercontent.com',
              discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
              scopes: 'https://www.googleapis.com/auth/calendar.readonly'
            },
            firebase: {
              apiKey: "FIREBASE_KEY_PLACEHOLDER",
              authDomain: "whoa-geier.firebaseapp.com",
              projectId: "whoa-geier",
              storageBucket: "whoa-geier.firebasestorage.app",
              messagingSenderId: "457123034868",
              appId: "1:457123034868:web:4dac03baaae1786da390a1",
              measurementId: "G-YEFTQYSHBR"
            },
            useFirebaseProxy: false,
            useFirestore: true,
            githubToken: 'GHAI_TOKEN_PLACEHOLDER',
            weatherApiKey: 'WEATHER_KEY_PLACEHOLDER',
            defaultCity: 'Minneapolis'
          };
          EOF
          sed -i "s|FIREBASE_KEY_PLACEHOLDER|$FIREBASE_KEY|g" src/environments/environment.prod.ts
          sed -i "s|GHAI_TOKEN_PLACEHOLDER|$GHAI_TOKEN_VAR|g" src/environments/environment.prod.ts
          sed -i "s|WEATHER_KEY_PLACEHOLDER|$WEATHER_KEY|g" src/environments/environment.prod.ts
          echo "✅ Production environment file created with secrets"
          echo "Verifying environment file (first 30 lines, secrets masked):"
          head -30 src/environments/environment.prod.ts | sed 's/AIza[A-Za-z0-9_-]*/AIza***MASKED***/g' | sed 's/github_pat_[A-Za-z0-9_-]*/github_pat_***MASKED***/g' | sed 's/ghp_[A-Za-z0-9_-]*/ghp_***MASKED***/g'
          
      - name: Build Angular app
        run: npm run build -- --configuration production --base-href /whoa-geier/
        
      - name: Copy index.html as 404.html for GitHub Pages routing
        run: |
          cp dist/family-command-center/browser/index.html dist/family-command-center/browser/404.html
          echo "✅ Copied index.html to 404.html for client-side routing"
        
      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist/family-command-center/browser
          cname: false
